!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("three")):"function"==typeof define&&define.amd?define(["three"],t):"object"==typeof exports?exports.THREEx=t(require("three")):e.THREEx=t(e.THREE)}(this,(e=>(()=>{"use strict";var t={381:t=>{t.exports=e}},i={};function n(e){var o=i[e];if(void 0!==o)return o.exports;var s=i[e]={exports:{}};return t[e](s,s.exports,n),s.exports}n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};return(()=>{n.r(o),n.d(o,{DeviceOrientationControls:()=>l,LocationBased:()=>i,WebcamRenderer:()=>s});var e=n(381);class t{constructor(){this.EARTH=40075016.68,this.HALF_EARTH=20037508.34}project(e,t){return[this.lonToSphMerc(e),this.latToSphMerc(t)]}unproject(e){return[this.sphMercToLon(e[0]),this.sphMercToLat(e[1])]}lonToSphMerc(e){return e/180*this.HALF_EARTH}latToSphMerc(e){return Math.log(Math.tan((90+e)*Math.PI/360))/(Math.PI/180)*this.HALF_EARTH/180}sphMercToLon(e){return e/this.HALF_EARTH*180}sphMercToLat(e){var t=e/this.HALF_EARTH*180;return 180/Math.PI*(2*Math.atan(Math.exp(t*Math.PI/180))-Math.PI/2)}getID(){return"epsg:3857"}}class i{constructor(e,i,n={}){this._scene=e,this._camera=i,this._proj=new t,this._eventHandlers={},this._lastCoords=null,this._gpsMinDistance=0,this._gpsMinAccuracy=1e3,this._watchPositionId=null,this.setGpsOptions(n)}setProjection(e){this._proj=e}setGpsOptions(e={}){void 0!==e.gpsMinDistance&&(this._gpsMinDistance=e.gpsMinDistance),void 0!==e.gpsMinAccuracy&&(this._gpsMinAccuracy=e.gpsMinAccuracy)}startGps(e=0){return null===this._watchPositionId&&(this._watchPositionId=navigator.geolocation.watchPosition((e=>{this._gpsReceived(e)}),(e=>{this._eventHandlers.gpserror?this._eventHandlers.gpserror(e.code):alert(`GPS error: code ${e.code}`)}),{enableHighAccuracy:!0,maximumAge:e}),!0)}stopGps(){return null!==this._watchPositionId&&(navigator.geolocation.clearWatch(this._watchPositionId),this._watchPositionId=null,!0)}fakeGps(e,t,i=null,n=0){null!==i&&this.setElevation(i),this._gpsReceived({coords:{longitude:e,latitude:t,accuracy:n}})}lonLatToWorldCoords(e,t){const i=this._proj.project(e,t);return[i[0],-i[1]]}add(e,t,i,n){this.setWorldPosition(e,t,i,n),this._scene.add(e)}setWorldPosition(e,t,i,n){const o=this.lonLatToWorldCoords(t,i);[e.position.x,e.position.z]=o,void 0!==n&&(e.position.y=n)}setElevation(e){this._camera.position.y=e}on(e,t){this._eventHandlers[e]=t}_gpsReceived(e){let t=Number.MAX_VALUE;e.coords.accuracy<=this._gpsMinAccuracy&&(null===this._lastCoords?this._lastCoords={latitude:e.coords.latitude,longitude:e.coords.longitude}:t=this._haversineDist(this._lastCoords,e.coords),t>=this._gpsMinDistance&&(this._lastCoords.longitude=e.coords.longitude,this._lastCoords.latitude=e.coords.latitude,this.setWorldPosition(this._camera,e.coords.longitude,e.coords.latitude),this._eventHandlers.gpsupdate&&this._eventHandlers.gpsupdate(e,t)))}_haversineDist(t,i){const n=e.Math.degToRad(i.longitude-t.longitude),o=e.Math.degToRad(i.latitude-t.latitude),s=Math.sin(o/2)*Math.sin(o/2)+Math.cos(e.Math.degToRad(t.latitude))*Math.cos(e.Math.degToRad(i.latitude))*(Math.sin(n/2)*Math.sin(n/2));return 2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))*6371e3}}class s{constructor(t,i){let n;this.renderer=t,this.renderer.autoClear=!1,this.sceneWebcam=new e.Scene,void 0===i?(n=document.createElement("video"),n.setAttribute("autoplay",!0),n.setAttribute("playsinline",!0),n.style.display="none",document.body.appendChild(n)):n=document.querySelector(i),this.geom=new e.PlaneBufferGeometry,this.texture=new e.VideoTexture(n),this.material=new e.MeshBasicMaterial({map:this.texture});const o=new e.Mesh(this.geom,this.material);if(this.sceneWebcam.add(o),this.cameraWebcam=new e.OrthographicCamera(-.5,.5,.5,-.5,0,10),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){const e={video:{width:1280,height:720,facingMode:"environment"}};navigator.mediaDevices.getUserMedia(e).then((e=>{console.log("using the webcam successfully..."),n.srcObject=e,n.play()})).catch((e=>{setTimeout((()=>{this.createErrorPopup("Webcam Error\nName: "+e.name+"\nMessage: "+e.message)}),1e3)}))}else setTimeout((()=>{this.createErrorPopup("sorry - media devices API not supported")}),1e3)}update(){this.renderer.clear(),this.renderer.render(this.sceneWebcam,this.cameraWebcam),this.renderer.clearDepth()}dispose(){this.material.dispose(),this.texture.dispose(),this.geom.dispose()}createErrorPopup(e){if(!document.getElementById("error-popup")){var t=document.createElement("div");t.innerHTML=e,t.setAttribute("id","error-popup"),document.body.appendChild(t)}}}const r=new e.Vector3(0,0,1),a=new e.Euler,c=new e.Quaternion,d=new e.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),h={type:"change"};class l extends e.EventDispatcher{constructor(t){super(),!1===window.isSecureContext&&console.error("THREE.DeviceOrientationControls: DeviceOrientationEvent is only available in secure contexts (https)");const i=this,n=new e.Quaternion;this.object=t,this.object.rotation.reorder("YXZ"),this.enabled=!0,this.deviceOrientation={},this.screenOrientation=0,this.alphaOffset=0,this.orientationChangeEventName="ondeviceorientationabsolute"in window?"deviceorientationabsolute":"deviceorientation";const o=function(e){i.deviceOrientation=e},s=function(){i.screenOrientation=window.orientation||0};this.connect=function(){s(),void 0!==window.DeviceOrientationEvent&&"function"==typeof window.DeviceOrientationEvent.requestPermission?window.DeviceOrientationEvent.requestPermission().then((e=>{"granted"===e&&(window.addEventListener("orientationchange",s),window.addEventListener(i.orientationChangeEventName,o))})).catch((function(e){console.error("THREE.DeviceOrientationControls: Unable to use DeviceOrientation API:",e)})):(window.addEventListener("orientationchange",s),window.addEventListener(i.orientationChangeEventName,o)),i.enabled=!0},this.disconnect=function(){window.removeEventListener("orientationchange",s),window.removeEventListener(i.orientationChangeEventName,o),i.enabled=!1},this.update=function(){if(!1===i.enabled)return;const t=i.deviceOrientation;if(t){const o=t.alpha?e.Math.degToRad(t.alpha)+i.alphaOffset:0,s=t.beta?e.Math.degToRad(t.beta):0,l=t.gamma?e.Math.degToRad(t.gamma):0,u=i.screenOrientation?e.Math.degToRad(i.screenOrientation):0;!function(e,t,i,n,o){a.set(i,t,-n,"YXZ"),e.setFromEuler(a),e.multiply(d),e.multiply(c.setFromAxisAngle(r,-o))}(i.object.quaternion,o,s,l,u),8*(1-n.dot(i.object.quaternion))>1e-6&&(n.copy(i.object.quaternion),i.dispatchEvent(h))}},this.dispose=function(){i.disconnect()},this.connect()}}})(),o})()));